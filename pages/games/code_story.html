<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Story - CodeQuest AI</title>
    <link rel="stylesheet" href="/assets/css/dashboard.css" />
    <link rel="stylesheet" href="/assets/css/games.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="game-container">
      <header class="game-header">
        <div class="header-content">
          <h1><i class="fas fa-book"></i> Code Story</h1>
          <p>Vi·∫øt c√¢u chuy·ªán b·∫±ng code!</p>
          <button class="btn-back" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i
          </button>
        </div>
      </header>

      <div class="story-container">
        <!-- Story Menu -->
        <div class="story-menu" id="story-menu">
          <div class="menu-options">
            <div class="option-card" onclick="createNewStory()">
              <div class="option-icon">
                <i class="fas fa-plus-circle"></i>
              </div>
              <h3>T·∫°o c√¢u chuy·ªán m·ªõi</h3>
              <p>Vi·∫øt m·ªôt c√¢u chuy·ªán m·ªõi b·∫±ng code</p>
            </div>

            <div class="option-card" onclick="viewStoryLibrary()">
              <div class="option-icon">
                <i class="fas fa-library"></i>
              </div>
              <h3>Th∆∞ vi·ªán c√¢u chuy·ªán</h3>
              <p>Xem c√°c c√¢u chuy·ªán ƒë√£ vi·∫øt</p>
            </div>

            <div class="option-card" onclick="exploreStoryTemplates()">
              <div class="option-icon">
                <i class="fas fa-magic"></i>
              </div>
              <h3>Template c√¢u chuy·ªán</h3>
              <p>S·ª≠ d·ª•ng template c√≥ s·∫µn</p>
            </div>
          </div>
        </div>

        <!-- Story Creator -->
        <div class="story-creator" id="story-creator" style="display: none">
          <div class="creator-header">
            <div class="header-info">
              <h3><i class="fas fa-pen-fancy"></i> Story Creator</h3>
              <p>K·∫øt h·ª£p code v√† c√¢u chuy·ªán ƒë·ªÉ t·∫°o n√™n t√°c ph·∫©m ƒë·ªôc ƒë√°o!</p>
            </div>
            <div class="header-actions">
              <button class="btn-secondary" onclick="backToStoryMenu()">
                <i class="fas fa-arrow-left"></i> Quay l·∫°i
              </button>
              <button class="btn-success" onclick="saveStory()">
                <i class="fas fa-save"></i> L∆∞u c√¢u chuy·ªán
              </button>
            </div>
          </div>

          <div class="story-workspace">
            <div class="story-info">
              <div class="info-group">
                <label>Ti√™u ƒë·ªÅ c√¢u chuy·ªán:</label>
                <input
                  type="text"
                  id="story-title"
                  placeholder="Nh·∫≠p ti√™u ƒë·ªÅ c√¢u chuy·ªán..."
                />
              </div>
              <div class="info-group">
                <label>Th·ªÉ lo·∫°i:</label>
                <select id="story-genre">
                  <option value="adventure">Phi√™u l∆∞u</option>
                  <option value="mystery">B√≠ ·∫©n</option>
                  <option value="comedy">H√†i h∆∞·ªõc</option>
                  <option value="fantasy">Fantasy</option>
                  <option value="education">Gi√°o d·ª•c</option>
                </select>
              </div>
            </div>

            <div class="story-content">
              <div class="content-section">
                <h4><i class="fas fa-align-left"></i> N·ªôi dung c√¢u chuy·ªán</h4>
                <textarea
                  id="story-text"
                  placeholder="Vi·∫øt c√¢u chuy·ªán c·ªßa b·∫°n t·∫°i ƒë√¢y...

V√≠ d·ª•: 
Ng√†y x·ª≠a ng√†y x∆∞a, c√≥ m·ªôt l·∫≠p tr√¨nh vi√™n t√™n l√† Alice. C√¥ ·∫•y ƒëang h·ªçc c√°ch s·ª≠ d·ª•ng v√≤ng l·∫∑p ƒë·ªÉ gi·∫£i quy·∫øt c√°c b√†i to√°n ph·ª©c t·∫°p..."
                ></textarea>
              </div>

              <div class="code-section">
                <h4><i class="fas fa-code"></i> Code minh h·ªça</h4>
                <textarea
                  id="story-code"
                  placeholder="Vi·∫øt code minh h·ªça cho c√¢u chuy·ªán...

# V√≠ d·ª•:
def alice_adventure():
    for day in range(7):
        print(f'Ng√†y {day + 1}: Alice h·ªçc ƒë∆∞·ª£c ƒëi·ªÅu m·ªõi!')
    
alice_adventure()"
                ></textarea>

                <div class="code-actions">
                  <button class="btn-primary" onclick="runStoryCode()">
                    <i class="fas fa-play"></i> Ch·∫°y code
                  </button>
                  <button class="btn-secondary" onclick="formatStoryCode()">
                    <i class="fas fa-magic"></i> Format code
                  </button>
                </div>
              </div>
            </div>

            <div class="story-preview">
              <h4><i class="fas fa-eye"></i> Xem tr∆∞·ªõc</h4>
              <div class="preview-content" id="story-preview">
                <p class="preview-placeholder">
                  Vi·∫øt c√¢u chuy·ªán v√† code ƒë·ªÉ xem tr∆∞·ªõc...
                </p>
              </div>
              <div class="code-output" id="story-code-output">
                <!-- Code output will appear here -->
              </div>
            </div>
          </div>

          <div class="story-tools">
            <div class="tool-group">
              <h5><i class="fas fa-tools"></i> C√¥ng c·ª• h·ªó tr·ª£</h5>
              <button class="tool-btn" onclick="insertCharacterTemplate()">
                <i class="fas fa-user"></i> Th√™m nh√¢n v·∫≠t
              </button>
              <button class="tool-btn" onclick="insertCodeTemplate()">
                <i class="fas fa-code"></i> Template code
              </button>
              <button class="tool-btn" onclick="insertDialogTemplate()">
                <i class="fas fa-comments"></i> H·ªôi tho·∫°i
              </button>
              <button class="tool-btn" onclick="generateStoryIdea()">
                <i class="fas fa-lightbulb"></i> G·ª£i √Ω √Ω t∆∞·ªüng
              </button>
            </div>
          </div>
        </div>

        <!-- Story Library -->
        <div class="story-library" id="story-library" style="display: none">
          <div class="library-header">
            <h3><i class="fas fa-library"></i> Th∆∞ vi·ªán Code Story</h3>
            <button class="btn-secondary" onclick="backToStoryMenu()">
              <i class="fas fa-arrow-left"></i> Quay l·∫°i
            </button>
          </div>

          <div class="library-filters">
            <select id="genre-filter">
              <option value="all">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
              <option value="adventure">Phi√™u l∆∞u</option>
              <option value="mystery">B√≠ ·∫©n</option>
              <option value="comedy">H√†i h∆∞·ªõc</option>
              <option value="fantasy">Fantasy</option>
              <option value="education">Gi√°o d·ª•c</option>
            </select>
            <input
              type="text"
              id="search-stories"
              placeholder="T√¨m ki·∫øm c√¢u chuy·ªán..."
            />
          </div>

          <div class="stories-grid" id="stories-grid">
            <!-- Stories will be loaded here -->
          </div>
        </div>

        <!-- Story Reader -->
        <div class="story-reader" id="story-reader" style="display: none">
          <div class="reader-header">
            <h3 id="reader-title">Story Title</h3>
            <div class="reader-actions">
              <button class="btn-secondary" onclick="backToLibrary()">
                <i class="fas fa-arrow-left"></i> Quay l·∫°i th∆∞ vi·ªán
              </button>
              <button class="btn-primary" onclick="editCurrentStory()">
                <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a
              </button>
            </div>
          </div>

          <div class="reader-content">
            <div class="story-metadata">
              <span class="genre-badge" id="reader-genre">Adventure</span>
              <span class="date-info" id="reader-date">T·∫°o: --/--/----</span>
            </div>

            <div class="story-text-content" id="reader-story-text">
              <!-- Story content will be loaded here -->
            </div>

            <div class="story-code-content">
              <h4><i class="fas fa-code"></i> Code minh h·ªça</h4>
              <pre><code id="reader-code" class="language-python"></code></pre>
              <button class="btn-primary" onclick="runReaderCode()">
                <i class="fas fa-play"></i> Ch·∫°y code
              </button>
            </div>

            <div class="code-execution-result" id="reader-code-output">
              <!-- Code output will appear here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script>
      let currentStory = null;
      let stories = [];

      function showNotification(message, type = "info") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      function createNewStory() {
        document.getElementById("story-menu").style.display = "none";
        document.getElementById("story-creator").style.display = "block";

        // Clear form
        document.getElementById("story-title").value = "";
        document.getElementById("story-text").value = "";
        document.getElementById("story-code").value = "";
        document.getElementById("story-genre").value = "adventure";
        document.getElementById("story-preview").innerHTML =
          '<p class="preview-placeholder">Vi·∫øt c√¢u chuy·ªán v√† code ƒë·ªÉ xem tr∆∞·ªõc...</p>';
        document.getElementById("story-code-output").innerHTML = "";

        currentStory = null;
      }

      function viewStoryLibrary() {
        document.getElementById("story-menu").style.display = "none";
        document.getElementById("story-library").style.display = "block";
        loadStories();
      }

      function exploreStoryTemplates() {
        createNewStory();

        // Load a sample template
        const template = {
          title: "Cu·ªôc phi√™u l∆∞u c·ªßa Python Bot",
          genre: "adventure",
          story: `Ng√†y x·ª≠a ng√†y x∆∞a, trong th·∫ø gi·ªõi s·ªë, c√≥ m·ªôt robot t√™n l√† PyBot. PyBot c√≥ kh·∫£ nƒÉng ƒë·∫∑c bi·ªát: c·∫≠u c√≥ th·ªÉ th·ª±c hi·ªán b·∫•t k·ª≥ t√°c v·ª• n√†o b·∫±ng code Python!

M·ªôt ng√†y n·ªç, PyBot nh·∫≠n ƒë∆∞·ª£c nhi·ªám v·ª• t·∫°o ra 10 ng√¥i sao ƒë·ªÉ trang tr√≠ b·∫ßu tr·ªùi ƒë√™m. V·ªõi s·ª± h√°o h·ª©c, PyBot b·∫Øt ƒë·∫ßu vi·∫øt code...`,
          code: `# PyBot t·∫°o ng√¥i sao
def create_stars():
    for i in range(10):
        print(f"‚≠ê Ng√¥i sao {i + 1} ƒë√£ ƒë∆∞·ª£c t·∫°o!")
    print("\\nüåü PyBot ƒë√£ ho√†n th√†nh nhi·ªám v·ª•!")

create_stars()`,
        };

        document.getElementById("story-title").value = template.title;
        document.getElementById("story-genre").value = template.genre;
        document.getElementById("story-text").value = template.story;
        document.getElementById("story-code").value = template.code;

        updateStoryPreview();
        showNotification("ƒê√£ t·∫£i template m·∫´u!", "success");
      }

      function backToStoryMenu() {
        document.getElementById("story-creator").style.display = "none";
        document.getElementById("story-library").style.display = "none";
        document.getElementById("story-reader").style.display = "none";
        document.getElementById("story-menu").style.display = "block";
      }

      function updateStoryPreview() {
        const title = document.getElementById("story-title").value;
        const text = document.getElementById("story-text").value;
        const genre = document.getElementById("story-genre").value;

        if (!title && !text) {
          document.getElementById("story-preview").innerHTML =
            '<p class="preview-placeholder">Vi·∫øt c√¢u chuy·ªán v√† code ƒë·ªÉ xem tr∆∞·ªõc...</p>';
          return;
        }

        const previewHTML = `
                <div class="preview-story">
                    <h3>${title || "C√¢u chuy·ªán ch∆∞a c√≥ ti√™u ƒë·ªÅ"}</h3>
                    <div class="preview-genre">
                        <span class="genre-badge">${getGenreText(genre)}</span>
                    </div>
                    <div class="preview-text">
                        ${
                          text
                            .split("\n")
                            .map((p) => (p.trim() ? `<p>${p}</p>` : ""))
                            .join("") || "<p><em>Ch∆∞a c√≥ n·ªôi dung...</em></p>"
                        }
                    </div>
                </div>
            `;

        document.getElementById("story-preview").innerHTML = previewHTML;
      }

      function getGenreText(genre) {
        const genres = {
          adventure: "Phi√™u l∆∞u",
          mystery: "B√≠ ·∫©n",
          comedy: "H√†i h∆∞·ªõc",
          fantasy: "Fantasy",
          education: "Gi√°o d·ª•c",
        };
        return genres[genre] || genre;
      }

      function runStoryCode() {
        const code = document.getElementById("story-code").value;
        const outputElement = document.getElementById("story-code-output");

        if (!code.trim()) {
          outputElement.innerHTML =
            '<div class="code-output-warning">Vui l√≤ng vi·∫øt code tr∆∞·ªõc khi ch·∫°y</div>';
          return;
        }

        // Simulate code execution (in real app, use sandboxed environment)
        let output = "";

        try {
          if (code.includes("create_stars") || code.includes("‚≠ê")) {
            output =
              "‚≠ê Ng√¥i sao 1 ƒë√£ ƒë∆∞·ª£c t·∫°o!\n‚≠ê Ng√¥i sao 2 ƒë√£ ƒë∆∞·ª£c t·∫°o!\n‚≠ê Ng√¥i sao 3 ƒë√£ ƒë∆∞·ª£c t·∫°o!\n...\nüåü PyBot ƒë√£ ho√†n th√†nh nhi·ªám v·ª•!";
          } else if (code.includes("for") && code.includes("print")) {
            output =
              "ƒêang th·ª±c hi·ªán v√≤ng l·∫∑p...\nK·∫øt qu·∫£ 1\nK·∫øt qu·∫£ 2\nK·∫øt qu·∫£ 3\n...";
          } else if (code.includes("input")) {
            output = "Ch∆∞∆°ng tr√¨nh ƒëang ch·ªù input t·ª´ ng∆∞·ªùi d√πng...";
          } else {
            output =
              "Code ƒë√£ ch·∫°y th√†nh c√¥ng!\nK·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã t√πy thu·ªôc v√†o logic c·ªßa code.";
          }

          outputElement.innerHTML = `<div class="code-output-success"><pre>${output}</pre></div>`;
        } catch (error) {
          outputElement.innerHTML = `<div class="code-output-error">L·ªói: ${error.message}</div>`;
        }
      }

      function formatStoryCode() {
        const codeTextarea = document.getElementById("story-code");
        let code = codeTextarea.value;

        // Simple formatting
        code = code.replace(/;/g, "\n");
        code = code.replace(/\n\s*\n/g, "\n");

        codeTextarea.value = code;
        showNotification("Code ƒë√£ ƒë∆∞·ª£c format!", "success");
      }

      function insertCharacterTemplate() {
        const textarea = document.getElementById("story-text");
        const template = `

Nh√¢n v·∫≠t m·ªõi: [T√™n nh√¢n v·∫≠t]
- Tu·ªïi: [tu·ªïi]
- T√≠nh c√°ch: [m√¥ t·∫£ t√≠nh c√°ch]
- K·ªπ nƒÉng ƒë·∫∑c bi·ªát: [k·ªπ nƒÉng l·∫≠p tr√¨nh]

[T√™n nh√¢n v·∫≠t] b∆∞·ªõc v√†o c√¢u chuy·ªán v√†...`;

        textarea.value += template;
        updateStoryPreview();
      }

      function insertCodeTemplate() {
        const textarea = document.getElementById("story-code");
        const template = `

# H√†m m·ªõi cho c√¢u chuy·ªán
def new_function():
    # Th√™m logic t·∫°i ƒë√¢y
    for i in range(5):
        print(f"B∆∞·ªõc {i + 1}: Th·ª±c hi·ªán h√†nh ƒë·ªông...")
    
new_function()`;

        textarea.value += template;
      }

      function insertDialogTemplate() {
        const textarea = document.getElementById("story-text");
        const template = `

"C√¢u n√≥i c·ªßa nh√¢n v·∫≠t A," nh√¢n v·∫≠t A n√≥i.

"Ph·∫£n h·ªìi c·ªßa nh√¢n v·∫≠t B," nh√¢n v·∫≠t B tr·∫£ l·ªùi.

V√† cu·ªôc h·ªôi tho·∫°i ti·∫øp t·ª•c...`;

        textarea.value += template;
        updateStoryPreview();
      }

      function generateStoryIdea() {
        const ideas = [
          "M·ªôt robot h·ªçc c√°ch y√™u th∆∞∆°ng th√¥ng qua vi·ªác debug code",
          "Cu·ªôc phi√™u l∆∞u trong th·∫ø gi·ªõi c·ªßa c√°c thu·∫≠t to√°n s·∫Øp x·∫øp",
          "C√¢u chuy·ªán v·ªÅ m·ªôt AI mu·ªën tr·ªü th√†nh ngh·ªá sƒ©",
          "H√†nh tr√¨nh t√¨m ki·∫øm bug trong m·ªôt ch∆∞∆°ng tr√¨nh c·ªï",
          "Cu·ªôc thi l·∫≠p tr√¨nh gi·ªØa c√°c sinh v·∫≠t trong r·ª´ng",
          "M·ªôt c√¥ b√© h·ªçc code ƒë·ªÉ c·ª©u th·∫ø gi·ªõi kh·ªèi virus",
          "Chuy·ªán t√¨nh gi·ªØa hai function trong m·ªôt ch∆∞∆°ng tr√¨nh",
          "Cu·ªôc phi√™u l∆∞u c·ªßa m·ªôt bi·∫øn qua c√°c scope kh√°c nhau",
        ];

        const randomIdea = ideas[Math.floor(Math.random() * ideas.length)];
        showNotification(`üí° √ù t∆∞·ªüng: ${randomIdea}`, "info");
      }

      async function saveStory() {
        const title = document.getElementById("story-title").value.trim();
        const story = document.getElementById("story-text").value.trim();
        const code = document.getElementById("story-code").value.trim();
        const genre = document.getElementById("story-genre").value;

        if (!title) {
          showNotification("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ c√¢u chuy·ªán", "warning");
          return;
        }

        if (!story) {
          showNotification("Vui l√≤ng vi·∫øt n·ªôi dung c√¢u chuy·ªán", "warning");
          return;
        }

        try {
          const response = await fetch("/api/games/story/save", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              title: title,
              story: story,
              code: code,
            }),
          });

          const data = await response.json();

          if (data.success) {
            showNotification("Code Story ƒë√£ ƒë∆∞·ª£c l∆∞u!", "success");
            currentStory = {
              id: data.story_id,
              title: title,
              story: story,
              code: code,
              genre: genre,
            };
          } else {
            showNotification(
              data.message || "Kh√¥ng th·ªÉ l∆∞u c√¢u chuy·ªán",
              "error"
            );
          }
        } catch (error) {
          console.error("Error saving story:", error);
          showNotification("C√≥ l·ªói x·∫£y ra khi l∆∞u", "error");
        }
      }

      async function loadStories() {
        try {
          const response = await fetch("/api/games/story/list");
          const data = await response.json();

          if (data.success) {
            stories = data.stories;
            displayStories(stories);
          }
        } catch (error) {
          console.error("Error loading stories:", error);
          showNotification("Kh√¥ng th·ªÉ t·∫£i danh s√°ch c√¢u chuy·ªán", "error");
        }
      }

      function displayStories(storiesToShow) {
        const grid = document.getElementById("stories-grid");

        if (storiesToShow.length === 0) {
          grid.innerHTML =
            '<div class="no-stories">Ch∆∞a c√≥ c√¢u chuy·ªán n√†o ƒë∆∞·ª£c l∆∞u</div>';
          return;
        }

        grid.innerHTML = storiesToShow
          .map(
            (story) => `
                <div class="story-card" onclick="readStory('${story.id}')">
                    <div class="story-card-header">
                        <h4>${story.title}</h4>
                        <span class="genre-badge">${getGenreText(
                          story.genre || "adventure"
                        )}</span>
                    </div>
                    <div class="story-card-content">
                        <p>${story.story.substring(0, 150)}${
              story.story.length > 150 ? "..." : ""
            }</p>
                    </div>
                    <div class="story-card-footer">
                        <small><i class="fas fa-calendar"></i> ${new Date(
                          story.created_at * 1000
                        ).toLocaleDateString()}</small>
                        <div class="story-actions">
                            <button class="btn-sm btn-primary" onclick="event.stopPropagation(); editStory('${
                              story.id
                            }')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function readStory(storyId) {
        const story = stories.find((s) => s.id === storyId);
        if (!story) return;

        document.getElementById("story-library").style.display = "none";
        document.getElementById("story-reader").style.display = "block";

        // Load story into reader
        document.getElementById("reader-title").textContent = story.title;
        document.getElementById("reader-genre").textContent = getGenreText(
          story.genre || "adventure"
        );
        document.getElementById("reader-date").textContent = `T·∫°o: ${new Date(
          story.created_at * 1000
        ).toLocaleDateString()}`;
        document.getElementById("reader-story-text").innerHTML = story.story
          .split("\n")
          .map((p) => (p.trim() ? `<p>${p}</p>` : ""))
          .join("");
        document.getElementById("reader-code").textContent =
          story.code || "# Kh√¥ng c√≥ code";

        currentStory = story;
        Prism.highlightAll();
      }

      function backToLibrary() {
        document.getElementById("story-reader").style.display = "none";
        document.getElementById("story-library").style.display = "block";
      }

      function editCurrentStory() {
        if (!currentStory) return;

        document.getElementById("story-reader").style.display = "none";
        document.getElementById("story-creator").style.display = "block";

        // Load story into editor
        document.getElementById("story-title").value = currentStory.title;
        document.getElementById("story-text").value = currentStory.story;
        document.getElementById("story-code").value = currentStory.code || "";
        document.getElementById("story-genre").value =
          currentStory.genre || "adventure";

        updateStoryPreview();
      }

      function runReaderCode() {
        if (!currentStory || !currentStory.code) return;

        const outputElement = document.getElementById("reader-code-output");

        // Simulate code execution
        let output =
          "Code ƒë√£ ch·∫°y th√†nh c√¥ng!\nK·∫øt qu·∫£ hi·ªÉn th·ªã t√πy thu·ªôc v√†o logic code.";

        if (currentStory.code.includes("create_stars")) {
          output =
            "‚≠ê Ng√¥i sao 1 ƒë√£ ƒë∆∞·ª£c t·∫°o!\n‚≠ê Ng√¥i sao 2 ƒë√£ ƒë∆∞·ª£c t·∫°o!\nüåü Ho√†n th√†nh!";
        }

        outputElement.innerHTML = `<div class="code-output-success"><pre>${output}</pre></div>`;
      }

      // Add event listeners
      document.addEventListener("DOMContentLoaded", () => {
        // Auto-update preview when typing
        ["story-title", "story-text", "story-genre"].forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("input", updateStoryPreview);
          }
        });
      });
    </script>
  </body>
</html>
