<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒêƒÉng Nh·∫≠p | CodeQuest AI</title>
    <link rel="stylesheet" href="../assets/css/auth.css" />
  </head>
  <body>
    <!-- Back to Home Button -->
    <div style="position: absolute; top: 20px; left: 20px; z-index: 100">
      <a
        href="/home"
        style="
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 10px 16px;
          background: var(--bg-tertiary);
          color: var(--text-primary);
          text-decoration: none;
          border-radius: var(--radius);
          border: 1px solid var(--border);
          transition: all 0.2s;
          font-size: 14px;
        "
        onmouseover="this.style.background='var(--border)'"
        onmouseout="this.style.background='var(--bg-tertiary)'"
      >
        ‚Üê V·ªÅ Trang Ch·ªß
      </a>
    </div>

    <div class="auth-container">
      <!-- Welcome Panel -->
      <div class="welcome-panel">
        <div
          class="logo_header"
          style="
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
          "
        >
          <img
            onclick="location.href='/home'"
            src="../assets/image/logo.png"
            alt="Logo"
            class="logo-animate"
            style="height: 50px; width: auto; cursor: pointer"
          />
          <a
            href="/home"
            style="
              color: inherit;
              text-decoration: none;
              cursor: pointer;
              font-size: 28px;
              font-weight: bold;
            "
            >CodeQuest</a
          >
        </div>
        <h1>
          <span style="color: inherit">Ch√†o m·ª´ng ƒë·∫øn v·ªõi CodeQuest AI</span>
        </h1>
        <p class="welcome-text">
          N·ªÅn t·∫£ng h·ªçc l·∫≠p tr√¨nh ƒë∆∞·ª£c t·ªëi ∆∞u b·ªüi tr√≠ tu·ªá nh√¢n t·∫°o. H·ªçc nhanh
          h∆°n, th√¥ng minh h∆°n c√πng AI mentor c√° nh√¢n.
        </p>
        <ul class="feature-list">
          <li>AI Mentor 24/7</li>
          <li>H·ªçc T·∫≠p C√° Nh√¢n H√≥a</li>
          <li>Th·ª±c H√†nh T∆∞∆°ng T√°c</li>
        </ul>
      </div>

      <!-- Auth Panel -->
      <div class="auth-panel">
        <!-- Tabs -->
        <div class="auth-tabs">
          <button class="tab-btn active" onclick="switchTab('login')">
            ƒêƒÉng Nh·∫≠p
          </button>
          <button class="tab-btn" onclick="switchTab('register')">
            ƒêƒÉng K√Ω
          </button>
        </div>

        <!-- Login Form -->
        <div id="login" class="tab-content active">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input
              type="email"
              class="form-input"
              placeholder="Nh·∫≠p email c·ªßa b·∫°n"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">M·∫≠t kh·∫©u</label>
            <input
              type="password"
              class="form-input"
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
              required
            />
          </div>
          <div class="checkbox-wrapper">
            <input type="checkbox" id="remember" class="checkbox" />
            <label for="remember" class="checkbox-label"
              >Ghi nh·ªõ ƒëƒÉng nh·∫≠p</label
            >
            <a
              href="javascript:void(0)"
              class="forgot-link"
              onclick="alert('Ch·ª©c nƒÉng ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t s·ªõm!')"
              >Qu√™n m·∫≠t kh·∫©u?</a
            >
          </div>
          <button type="submit" class="btn-primary">ƒêƒÉng Nh·∫≠p</button>

          <div class="divider">
            <span>ho·∫∑c</span>
          </div>

          <button class="btn-secondary"><span>üîç</span> Google</button>
        </div>

        <!-- Register Form -->
        <div id="register" class="tab-content">
          <div class="form-group">
            <label class="form-label">H·ªç v√† t√™n</label>
            <input
              type="text"
              class="form-input"
              placeholder="Nh·∫≠p h·ªç v√† t√™n"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input
              type="email"
              class="form-input"
              placeholder="Nh·∫≠p email c·ªßa b·∫°n"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">M·∫≠t kh·∫©u</label>
            <input
              type="password"
              class="form-input"
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u (t·ªëi thi·ªÉu 8 k√Ω t·ª±)"
              required
            />
            <div class="password-strength">
              <div class="strength-bar">
                <div class="strength-fill"></div>
              </div>
              <span class="strength-text">ƒê·ªô m·∫°nh m·∫≠t kh·∫©u</span>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
            <input
              type="password"
              class="form-input"
              placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
              required
            />
          </div>
          <div class="checkbox-wrapper">
            <input type="checkbox" id="terms" class="checkbox" required />
            <label for="terms" class="checkbox-label"
              >T√¥i ƒë·ªìng √Ω v·ªõi ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</label
            >
          </div>
          <button type="submit" class="btn-primary">T·∫°o T√†i Kho·∫£n</button>

          <div class="divider">
            <span>ho·∫∑c</span>
          </div>

          <button class="btn-secondary"><span>üîç</span> Google</button>
        </div>
      </div>
    </div>

    <script>
      // Tab switching function
      function switchTab(tabName) {
        // Update active tab button
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));

        // Find and activate the correct tab button
        const buttons = document.querySelectorAll(".tab-btn");
        if (tabName === "login") {
          buttons[0].classList.add("active");
        } else if (tabName === "register") {
          buttons[1].classList.add("active");
        }

        // Update active tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(tabName).classList.add("active");
      }

      // Utility functions
      function showMessage(message, type = "info") {
        // T·∫°o th√¥ng b√°o t·∫°m th·ªùi
        const messageDiv = document.createElement("div");
        messageDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 10000;
          max-width: 400px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;

        if (type === "success") {
          messageDiv.style.background = "#10b981";
        } else if (type === "error") {
          messageDiv.style.background = "#ef4444";
        } else {
          messageDiv.style.background = "#3b82f6";
        }

        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);

        setTimeout(() => {
          document.body.removeChild(messageDiv);
        }, 5000);
      }

      function setLoading(formType, isLoading) {
        const button = document.querySelector(
          `#${formType} button[type="submit"]`
        );
        if (button) {
          button.disabled = isLoading;
          button.textContent = isLoading
            ? "ƒêang x·ª≠ l√Ω..."
            : formType === "login"
            ? "ƒêƒÉng Nh·∫≠p"
            : "T·∫°o T√†i Kho·∫£n";
        }
      }

      // API functions
      async function handleLogin(event) {
        event.preventDefault();

        const form = event.target.closest("#login");
        const email = form.querySelector('input[type="email"]').value.trim();
        const password = form.querySelector('input[type="password"]').value;
        const remember = form.querySelector("#remember").checked;

        if (!email || !password) {
          showMessage("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin", "error");
          return;
        }

        setLoading("login", true);

        try {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: email,
              password: password,
              remember: remember,
            }),
          });

          const data = await response.json();

          if (data.success) {
            showMessage(data.message, "success");
            setTimeout(() => {
              window.location.href = "/dashboard";
            }, 1500);
          } else {
            showMessage(data.message, "error");
          }
        } catch (error) {
          console.error("Login error:", error);
          showMessage("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i", "error");
        } finally {
          setLoading("login", false);
        }
      }

      async function handleRegister(event) {
        event.preventDefault();

        const form = event.target.closest("#register");
        const fullName = form.querySelector('input[type="text"]').value.trim();
        const email = form.querySelector('input[type="email"]').value.trim();
        const password = form.querySelectorAll('input[type="password"]')[0]
          .value;
        const confirmPassword = form.querySelectorAll(
          'input[type="password"]'
        )[1].value;
        const agreeTerms = form.querySelector("#terms").checked;

        // Validation
        if (!fullName) {
          showMessage("Vui l√≤ng nh·∫≠p h·ªç v√† t√™n", "error");
          return;
        }

        if (!email) {
          showMessage("Vui l√≤ng nh·∫≠p email", "error");
          return;
        }

        if (!password) {
          showMessage("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u", "error");
          return;
        }

        if (password !== confirmPassword) {
          showMessage("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp", "error");
          return;
        }

        if (!agreeTerms) {
          showMessage("Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng", "error");
          return;
        }

        setLoading("register", true);

        try {
          const response = await fetch("/api/auth/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              full_name: fullName,
              email: email,
              password: password,
              confirm_password: confirmPassword,
            }),
          });

          const data = await response.json();

          if (data.success) {
            showMessage(data.message, "success");
            // Chuy·ªÉn sang tab ƒëƒÉng nh·∫≠p sau 2 gi√¢y
            setTimeout(() => {
              switchTab("login");
              // Clear form
              form.reset();
            }, 2000);
          } else {
            showMessage(data.message, "error");
          }
        } catch (error) {
          console.error("Register error:", error);
          showMessage("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i", "error");
        } finally {
          setLoading("register", false);
        }
      }

      // Check URL parameter for initial tab
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get("tab");
        if (tab === "register") {
          switchTab("register");
        }

        // Add event listeners to forms
        const loginForm = document.querySelector("#login");
        const registerForm = document.querySelector("#register");

        if (loginForm) {
          const loginButton = loginForm.querySelector('button[type="submit"]');
          if (loginButton) {
            loginButton.addEventListener("click", handleLogin);
          }
        }

        if (registerForm) {
          const registerButton = registerForm.querySelector(
            'button[type="submit"]'
          );
          if (registerButton) {
            registerButton.addEventListener("click", handleRegister);
          }
        }

        // Password strength indicator
        const passwordInput = document.querySelector(
          '#register input[type="password"]'
        );
        if (passwordInput) {
          passwordInput.addEventListener("input", (e) => {
            const password = e.target.value;
            const strengthEl = document.querySelector(".password-strength");

            if (strengthEl) {
              let strength = "weak";
              if (
                password.length >= 8 &&
                /[A-Z]/.test(password) &&
                /[0-9]/.test(password)
              ) {
                strength = "strong";
              } else if (password.length >= 6) {
                strength = "good";
              } else if (password.length >= 4) {
                strength = "fair";
              }

              strengthEl.className = `password-strength strength-${strength}`;
            }
          });
        }

        // Check if user is already logged in
        checkAuthStatus();
      });

      // Check authentication status
      async function checkAuthStatus() {
        try {
          const response = await fetch("/api/auth/check-session");
          const data = await response.json();

          if (data.success && data.authenticated) {
            // User is already logged in, redirect to dashboard
            window.location.href = "/dashboard";
          }
        } catch (error) {
          // Ignore errors, user is not logged in
          console.log("Not authenticated");
        }
      }
    </script>
  </body>
</html>
